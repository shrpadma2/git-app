<!DOCTYPE html>
<html>
<head>
    <title>Simple Network Graph</title>
    <script src="./tableau.extensions.1.latest.js"></script>
    <script src="https://d3js.org/d3.v2.min.js"></script>
    <style>
        .link { stroke: #999; stroke-opacity: 0.6; }
        .node { fill: #ff5722; stroke: #fff; stroke-width: 1.5px; }
    </style>
</head>
<body>
    <div id="jsonDataDisplay"></div>
    <svg id="networkGraph" width="960" height="500"></svg>
    <script type="text/javascript">
        // Initialize Tableau extensions API and load data
        tableau.extensions.initializeAsync().then(function() {
            loadDataFromTableau();
        });

        function loadDataFromTableau() {
            const worksheetNodes = tableau.extensions.dashboardContent.dashboard.worksheets[0];
            const worksheetEdges = tableau.extensions.dashboardContent.dashboard.worksheets[1];

            worksheetNodes.getUnderlyingDataAsync().then(dataTableNodes => {
                let nodes = dataTableNodes.data.map(row => {
                    return {
                        id: row[0].formattedValue,
                        group: parseInt(row[1].formattedValue, 10)
                    };
                });

                worksheetEdges.getUnderlyingDataAsync().then(dataTableEdges => {
                    let links = dataTableEdges.data.map(row => {
                        return {
                            source: parseInt(row[1].formattedValue, 10), // Convert source to an integer
                            target: parseInt(row[0].formattedValue, 10), // Convert target to an integer
                            value: parseInt(row[2].formattedValue, 10) 
                        };
                    });

                    var json_data = { nodes: nodes, links: links };
                    displayJsonData(json_data);
                    createNetworkGraph(json_data);
                });
            });
        }

        function displayJsonData(jsonData) {
            var jsonDataDiv = document.getElementById('jsonDataDisplay');
            jsonDataDiv.innerHTML = '<h3>JSON Data</h3><pre>' + JSON.stringify(jsonData, null, 2) + '</pre>';
        }

        function createNetworkGraph(jsonData) {
            var width = 960, height = 500,
                svg = d3.select("#networkGraph"),
                force = d3.layout.force()
                    .nodes(jsonData.nodes)
                    .links(jsonData.links)
                    .size([width, height])
                    .linkDistance(100)
                    .charge(-100)
                    .start();

            var link = svg.selectAll(".link")
                .data(jsonData.links)
                .enter().append("line")
                .attr("class", "link");

            var node = svg.selectAll(".node")
                .data(jsonData.nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", 5)
                .call(force.drag);

            force.on("tick", function() {
                link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });
            });
        }
    </script>
</body>
</html>
